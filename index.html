<!DOCTYPE html>
<html>
<head>
    <title>ä¿®å‹¾é»˜å¥‘æŒ‘æˆ˜</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #607D8B;
            --success-color: #4CAF50;
            --error-color: #f44336;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .page {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
        }

        .active { display: block; }

        input[type="text"] {
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            width: 250px;
            font-size: 1rem;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .correct { color: var(--success-color); }
        .wrong { color: var(--error-color); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- æ³¨å†Œé¡µé¢ -->
    <div id="registerPage" class="page active">
        <h2>ğŸ“ ç”¨æˆ·æ³¨å†Œ</h2>
        <div>
            <input type="text" id="username" placeholder="è¾“å…¥ç”¨æˆ·å">
            <button onclick="checkUsername()">å¼€å§‹æŒ‘æˆ˜</button>
            <p id="usernameError" style="color:var(--error-color)"></p>
        </div>
    </div>

    <!-- ç­”é¢˜é¡µé¢ -->
    <div id="quizPage" class="page">
        <h2>ğŸ§  é»˜å¥‘æŒ‘æˆ˜ (<span id="currentUser"></span>)</h2>
        <form id="quizForm"></form>
        <p>â³ å·²ç”¨æ—¶ï¼š<span id="timer">0</span>ç§’</p>
    </div>

    <!-- ç»“æœé¡µé¢ -->
    <div id="resultPage" class="page">
        <h2>ğŸ¯ æŒ‘æˆ˜ç»“æœ</h2>
        <div id="personalResult"></div>
        <h3>ğŸ… å…¨çƒæ’è¡Œæ¦œ</h3>
        <div id="ranking"></div>
        <button onclick="showPage('registerPage')">è¿”å›é¦–é¡µ</button>
    </div>

<script>
// æ›¿æ¢ä¸ºä½ çš„Firebaseé…ç½®ï¼ï¼ï¼
const firebaseConfig = {
  apiKey: "AIzaSyAVnHnfEyFGj65afGLH3ghrP3Jar4uzcLQ",
  authDomain: "myquiz-c29b5.firebaseapp.com",
  projectId: "myquiz-c29b5",
  storageBucket: "myquiz-c29b5.firebasestorage.app",
  messagingSenderId: "895675606677",
  appId: "1:895675606677:web:8cd8ae3897fc3415dd9d9c"
};

// åˆå§‹åŒ–Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// é¢˜ç›®è®¾ç½®
const questions = [
    {
        question: "æˆ‘çš„èº«é«˜å¤§çº¦æ˜¯ï¼Ÿ",
        options: ["160ä»¥ä¸‹", "160-165", "166-170", "171-180"],
        answer: 2
    },
    {
        question: "æˆ‘å¸¸ç©çš„æ¸¸æˆä¸åŒ…æ‹¬ä»¥ä¸‹å“ªé¡¹ï¼Ÿ",
        options: ["å’Œå¹³ç²¾è‹±", "ç‹è€…è£è€€", "é‡‘é“²é“²", "æ˜æ—¥ä¹‹å"],
        answer: 2
    },
    {
        question: "æˆ‘çš„çˆ±å¥½ä¸åŒ…æ‹¬ä»¥ä¸‹å“ªé¡¹ï¼Ÿ",
        options: ["å‰ä»–", "æ¸¸æ³³", "å°çƒ", "æ‰“æ¸¸æˆ"],
        answer: 1
    },
    {
        question: "æˆ‘ç©ç‹è€…å¸¸æ‰“çš„ä½ç½®ï¼Ÿ",
        options: ["å°„æ‰‹", "æ‰“é‡", "è¾…åŠ©", "æ³•å¸ˆ"],
        answer: 3
    },
    {
        question: "æˆ‘å¸¸åƒçš„æ±‰å ¡å“ç‰Œï¼Ÿ",
        options: ["éº¦å½“åŠ³", "è‚¯å¾·åŸº", "å¡”æ–¯æ±€", "åè±å£«"],
        answer: 0
    },
    {
        question: "æˆ‘æ´—æ¾¡çš„æ—¶é•¿ï¼Ÿ",
        options: ["0-10åˆ†é’Ÿ", "10-20åˆ†é’Ÿ", "20-30åˆ†é’Ÿ", "30åˆ†é’Ÿä»¥ä¸Š"],
        answer: 1
    },
    {
        question: "æˆ‘çš„è¡€å‹ï¼Ÿ",
        options: ["A", "B", "AB", "O"],
        answer: 1
    },
    {
        question: "æˆ‘ç›¸å†Œä¸­æœ€å¤šçš„ç…§ç‰‡ç±»å‹ï¼Ÿ",
        options: ["ç”Ÿæ´»æ—¥å¸¸", "æ¸¸æˆæˆªå›¾", "è¡¨æƒ…åŒ…", "è‡ªæ‹"],
        answer: 0
    },
    {
        question: "æ‰‹æœºä¸­ä½¿ç”¨æ—¶é•¿æœ€å¤šçš„è½¯ä»¶ï¼Ÿ",
        options: ["å¾®ä¿¡", "QQ", "æŠ–éŸ³", "æ¸¸æˆ"],
        answer: 2
    },
    {
        question: "æœ€è®¨åŒå“ªç§é£Ÿç‰©ï¼Ÿ",
        options: ["é¦™èœ", "è‘±èŠ±", "å¤§è’œ", "èŠ±æ¤’"],
        answer: 2
    },
];

let startTime, timerInterval, currentUser;

// åˆå§‹åŒ–é¢˜ç›®
function initQuiz() {
    const form = document.getElementById("quizForm");
    form.innerHTML = questions.map((q, i) => `
        <div>
            <p>${i+1}. ${q.question}</p>
            ${q.options.map((o, j) => `
                <label>
                    <input type="radio" name="q${i}" value="${j}" required>
                    ${o}
                </label>
            `).join("")}
        </div>
    `).join("") + '<button type="submit">æäº¤ç­”æ¡ˆ</button>';
    form.onsubmit = submitQuiz;
}

// ç”¨æˆ·åæ£€æŸ¥
async function checkUsername() {
    const username = document.getElementById("username").value.trim();
    const errorEl = document.getElementById("usernameError");
    
    if (!username) {
        errorEl.textContent = "âš ï¸ ç”¨æˆ·åä¸èƒ½ä¸ºç©º";
        return;
    }

    try {
        const doc = await db.collection("users").doc(username).get();
        if (doc.exists) {
            showResult(doc.data());
            showPage("resultPage");
            errorEl.textContent = "âš ï¸ ç”¨æˆ·åå·²å­˜åœ¨ï¼Œæ˜¾ç¤ºå†å²è®°å½•";
            return;
        }

        currentUser = username;
        document.getElementById("currentUser").textContent = username;
        showPage("quizPage");
        startTimer();
        initQuiz();
    } catch (error) {
        alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•");
    }
}

// å¼€å§‹è®¡æ—¶
function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(() => {
        document.getElementById("timer").textContent = 
            Math.floor((Date.now() - startTime)/1000);
    }, 1000);
}

// æäº¤ç­”æ¡ˆ
async function submitQuiz(e) {
    e.preventDefault();
    clearInterval(timerInterval);
    const timeUsed = Math.floor((Date.now() - startTime)/1000);

    const formData = new FormData(e.target);
    const answers = questions.map((q, i) => ({
        question: q.question,
        selected: parseInt(formData.get(`q${i}`)),
        correct: q.answer
    }));

    const correctCount = answers.filter(a => a.selected === a.correct).length;
    const accuracy = (correctCount / questions.length * 100).toFixed(1);

    try {
        await db.collection("users").doc(currentUser).set({
            username: currentUser,
            time: timeUsed,
            accuracy: parseFloat(accuracy),
            answers: answers,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        showResult(currentUser);
        showPage("resultPage");
    } catch (error) {
        alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
    }
}
// ä¿®æ”¹åçš„showResultå‡½æ•°
async function showResult(userData) {
    try {
        // ä¸ªäººç»“æœ
        document.getElementById("personalResult").innerHTML = `
            <h4>${userData.username} çš„æˆç»©</h4>
            <p class="author-message">ğŸ‰ æƒ³è¯´çš„è¯ï¼šæ„Ÿè°¢å‚ä¸ï¼ä½ çš„æ¯ä¸€ä¸ªé€‰æ‹©éƒ½æ˜¯å¯¹æˆ‘çš„äº†è§£~</p>
            <p>ğŸ“Š æ­£ç¡®ç‡ï¼š${userData.accuracy}% | â±ï¸ ç”¨æ—¶ï¼š${userData.time}ç§’</p>
            <table>
                <tr><th>é¢˜ç›®</th><th>ä½ çš„ç­”æ¡ˆ</th><th>æ­£ç¡®ç­”æ¡ˆ</th></tr>
                ${userData.answers.map((a, i) => `
                    <tr>
                        <td>${i+1}. ${a.question}</td>
                        <td class="${a.selected === a.correct ? 'correct' : 'wrong'}">
                            ${questions[i].options[a.selected]}
                        </td>
                        <td>${questions[i].options[a.correct]}</td>
                    </tr>
                `).join("")}
            </table>
        `;

        // å…¨çƒæ’è¡Œæ¦œ
        const snapshot = await db.collection("users")
            .orderBy("accuracy", "desc")
            .limit(10)
            .get();
        
        document.getElementById("ranking").innerHTML = `
            <table>
                <tr><th>æ’å</th><th>ç”¨æˆ·</th><th>æ­£ç¡®ç‡</th><th>ç”¨æ—¶</th></tr>
                ${snapshot.docs.map((doc, i) => `
                    <tr>
                        <td>${i+1}</td>
                        <td><button class="user-detail-btn" onclick="showUserDetail('${doc.id}')">${doc.id}</button></td>
                        <td>${doc.data().accuracy}%</td>
                        <td>${doc.data().time}ç§’</td>
                    </tr>
                `).join("")}
            </table>
        `;
    } catch (error) {
        console.error(error);
    }
}

// å¢å¼ºçš„showUserDetailå‡½æ•°
async function showUserDetail(username) {
    try {
        const doc = await db.collection("users").doc(username).get();
        const user = doc.data();
        
        let detailHTML = `
            <div class="user-detail">
                <h4>${username} çš„ç­”é¢˜è¯¦æƒ…</h4>
                <p>â±ï¸ ç”¨æ—¶ï¼š${user.time}ç§’ | âœ… æ­£ç¡®ç‡ï¼š${user.accuracy}%</p>
                <table>
                    <tr><th>é¢˜ç›®</th><th>é€‰æ‹©</th><th>æ­£ç¡®</th></tr>
        `;

        user.answers.forEach((answer, index) => {
            const question = questions.find(q => q.question === answer.question);
            detailHTML += `
                <tr>
                    <td>${index+1}. ${answer.question}</td>
                    <td class="${answer.selected === answer.correct ? 'correct' : 'wrong'}">
                        ${question.options[answer.selected]}
                    </td>
                    <td>${question.options[answer.correct]}</td>
                </tr>
            `;
        });

        detailHTML += `</table></div>`;
        
        // åˆ›å»ºå¼¹çª—æ˜¾ç¤º
        const popup = document.createElement('div');
        popup.className = 'detail-popup';
        popup.innerHTML = `
            <div class="popup-content">
                ${detailHTML}
                <button onclick="this.parentElement.parentElement.remove()">å…³é—­</button>
            </div>
        `;
        document.body.appendChild(popup);
    } catch (error) {
        alert("è·å–è¯¦æƒ…å¤±è´¥ï¼š" + error.message);
    }
}
// é¡µé¢åˆ‡æ¢
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}

window.onload = initQuiz;
</script>
</body>
</html>
